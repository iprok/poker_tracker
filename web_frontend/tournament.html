<!doctype html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <title>Poker Stats - –î–µ—Ç–∞–ª–∏ –¢—É—Ä–Ω–∏—Ä–∞</title>
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body class="bg-gray-100 text-gray-900">
    <div class="max-w-6xl mx-auto p-4" x-data="tournamentDetails()" x-init="init()">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold flex items-center">
                üèÜ –¢—É—Ä–Ω–∏—Ä #<span x-text="tournament.id"></span>
                <span class="ml-4 text-base px-3 py-1 rounded-full border" x-text="tournament.statusTranslate" :class="{
                    'bg-green-100 text-green-800 border-green-200': tournament.status === 'Completed',
                    'bg-yellow-100 text-yellow-800 border-yellow-200': tournament.status === 'Active',
                    'bg-gray-100 text-gray-800 border-gray-200': tournament.status === 'Pending'
                }"></span>
            </h1>

            <a href="tournaments.html" class="text-blue-600 hover:underline">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
        </div>

        <!-- Info Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-4 rounded shadow">
                <div class="text-gray-500 text-sm">–ù–∞—á–∞–ª–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
                <div class="font-medium text-lg" x-text="formatDate(tournament.created_at)"></div>
            </div>
            <div class="bg-white p-4 rounded shadow">
                <div class="text-gray-500 text-sm">–ù–∞—á–∞–ª–æ</div>
                <div class="font-medium text-lg" x-text="formatDate(tournament.start_time)"></div>
            </div>
            <div class="bg-white p-4 rounded shadow">
                <div class="text-gray-500 text-sm">–ö–æ–Ω–µ—Ü</div>
                <div class="font-medium text-lg" x-text="formatDate(tournament.end_time)"></div>
            </div>
            <div class="bg-white p-4 rounded shadow">
                <div class="text-gray-500 text-sm">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                <div class="font-medium text-lg" x-text="tournament.duration || '-'"></div>
            </div>
        </div>

        <h2 class="text-xl font-bold mb-4">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ (<span x-text="tournament.participants?.length || 0"></span>)
        </h2>

        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-300 rounded shadow">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="p-2 text-left">–†–∞–Ω–≥</th>
                        <th class="p-2 text-left">–ò–≥—Ä–æ–∫</th>
                        <th class="p-2 text-left">–°—Ç–∞—Ç—É—Å</th>
                        <th class="p-2 text-left">–°—Ç–æ–ª</th>
                        <th class="p-2 text-left">–ü–æ–∑–∏—Ü–∏—è</th>
                        <th class="p-2 text-left">–í—Ä–µ–º—è –≤ –∏–≥—Ä–µ</th>
                        <th class="p-2 text-left">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è</th>
                        <th class="p-2 text-left">–í—ã–±—ã–ª</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="p in tournament.participants" :key="p.player_id">
                        <tr class="border-t hover:bg-gray-50" :class="{
                            'bg-green-100': p.rank >= 1 && p.rank <= 3,
                            'bg-red-50': p.status === 'Eliminated' && (p.rank > 3 || !p.rank)
                        }">
                            <td class="p-2 font-bold text-center w-16">
                                <span x-show="p.rank" x-text="getMedal(p.rank)"></span>
                                <span x-show="!p.rank">-</span>
                            </td>
                            <td class="p-2">
                                <div class="font-medium" x-text="p.name || p.username"></div>
                                <div class="text-xs text-gray-500" x-text="p.username ? '@' + p.username : ''"></div>
                            </td>
                            <td class="p-2">
                                <span class="px-2 py-1 rounded text-xs font-bold" :class="{
                                        'text-red-800': p.status === 'Eliminated',
                                        'text-green-800': p.status === 'Active',
                                        'text-blue-800': p.status === 'Registered',
                                    }" x-text="translateStatus(p.status)"></span>
                            </td>
                            <td class="p-2" x-text="p.table_number ?? '-'"></td>
                            <td class="p-2" x-text="p.position_number ?? '-'"></td>
                            <td class="p-2" x-text="formatDuration(p.duration_seconds)"></td>
                            <td class="p-2" x-text="formatDate(p.created_at)"></td>
                            <td class="p-2" x-text="formatDate(p.ended_at)"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        function tournamentDetails() {
            return {
                tournament: {},

                async init() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const id = urlParams.get('id');
                    if (!id) {
                        alert("Tournament ID not found");
                        window.location.href = 'tournaments.html';
                        return;
                    }

                    try {
                        const data = await fetchTournamentDetails(id);
                        this.tournament = {
                            ...data,
                            statusTranslate: this.translateTournamentStatus(data.status),
                            participants: data.participants.sort((a, b) => {
                                // Sort by rank (asc) first (null ranks last), then by joined (asc)
                                if (a.rank && b.rank) return a.rank - b.rank;
                                if (a.rank) return -1;
                                if (b.rank) return 1;
                                return new Date(a.created_at) - new Date(b.created_at);
                            })
                        };
                    } catch (err) {
                        console.error(err);
                        alert("Error loading tournament details");
                    }
                },

                translateTournamentStatus(status) {
                    const map = {
                        'Completed': '–ó–∞–≤–µ—Ä—à–µ–Ω',
                        'Active': '–ò–¥–µ—Ç',
                        'Pending': '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'
                    };
                    return map[status] || status;
                },

                translateStatus(status) {
                    const map = {
                        'Eliminated': '–í—ã–±—ã–ª',
                        'Active': '–í –∏–≥—Ä–µ',
                        'Registered': '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'
                    };
                    return map[status] || status;
                },

                getMedal(rank) {
                    if (rank === 1) return 'ü•á ' + rank;
                    if (rank === 2) return 'ü•à ' + rank;
                    if (rank === 3) return 'ü•â ' + rank;
                    return rank;
                },

                formatDate(dateString) {
                    if (!dateString) return "-";
                    // If dateString is naive (no Z or +), assume UTC by appending Z
                    const dateValue = (dateString.endsWith('Z') || dateString.includes('+'))
                        ? dateString
                        : dateString + 'Z';
                    const date = new Date(dateValue);
                    return date.toLocaleString(undefined, {
                        year: 'numeric',
                        month: 'numeric',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                formatDuration(seconds) {
                    if (!seconds) return "-";
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    const s = seconds % 60;
                    return [h, m, s].map(v => v.toString().padStart(2, '0')).join(':');
                }
            }
        }
    </script>
</body>

</html>