<!doctype html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <title>Poker Stats</title>
  <script src="config.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs" defer></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body class="bg-gray-100 text-gray-900">
  <div class="max-w-6xl mx-auto p-4" x-data="userStatsTable()" x-init="init()">
    <h1 class="text-2xl font-bold mb-4">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–æ–≤</h1>

    <div class="flex flex-wrap gap-4 mb-4 items-end bg-white p-4 rounded shadow border border-gray-200">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">üìÖ –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞</label>
        <input type="date" x-model="tableStartDate" class="border p-2 rounded w-40 h-[42px]">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">üìÖ –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞</label>
        <input type="date" x-model="tableEndDate" class="border p-2 rounded w-40 h-[42px]">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">&nbsp;</label>
        <div class="flex gap-2">
          <button @click="setAllTime()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded shadow transition whitespace-nowrap h-[42px] flex items-center justify-center">
            –ó–∞ –≤—Å—ë –≤—Ä–µ–º—è
          </button>
          <button @click="setThisYear()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded shadow transition whitespace-nowrap h-[42px] flex items-center justify-center">
            –ó–∞ —ç—Ç–æ—Ç –≥–æ–¥
          </button>
        </div>
      </div>
      <div class="ml-10 flex-grow">
        <label class="block text-sm font-medium text-gray-700 mb-1">üîç –ü–æ–∏—Å–∫</label>
        <input type="text" x-model="search" placeholder="–ò–º—è –∏–ª–∏ ID" class="border p-2 rounded w-full h-[42px]" />
      </div>
    </div>

    <label class="flex items-center mb-4 space-x-2">
      <input type="checkbox" x-model="hideSmallSample" class="form-checkbox h-4 w-4 text-blue-600" />
      <span>–ù–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å, –µ—Å–ª–∏ –º–µ–Ω—å—à–µ —Ç—Ä—ë—Ö –∏–≥—Ä</span>
    </label>

    <div class="overflow-x-auto">
      <table class="min-w-full bg-white border border-gray-300 rounded shadow">
        <thead class="bg-gray-200">
          <tr>
            <template x-for="header in headers" :key="header.field">
              <th class="p-2 text-left cursor-pointer select-none" @click="setSort(header.field)"
                :title="header.tooltip">
                <span x-text="header.label"></span>
                <span x-show="sortField === header.field">
                  <span x-show="sortAsc">‚ñ≤</span>
                  <span x-show="!sortAsc">‚ñº</span>
                </span>
              </th>
            </template>
          </tr>
        </thead>
        <tbody>
          <template x-for="user in filteredAndSorted" :key="user.user_id">
            <tr class="border-t hover:bg-gray-50">
              <td class="p-2">
                <template x-if="user.displayStats.games_played >= 3">
                  <a href="#" @click.prevent="openRoiChart(user)" class="text-blue-600 hover:underline"
                    x-text="user.username ?? user.user_id"></a>
                </template>
                <template x-if="user.displayStats.games_played < 3">
                  <span x-text="user.username ?? user.user_id"></span>
                </template>
              </td>
              <td class="p-2" x-text="user.displayStats.games_played"></td>
              <td class="p-2" x-text="Math.round(user.displayStats.total_buyin)"></td>
              <td class="p-2" x-text="Number(user.displayStats.avg_buyins_per_game.toFixed(2))"></td>
              <td class="p-2" x-text="Number(user.displayStats.profit.toFixed(2))"></td>
              <td class="p-2" x-text="Number(user.displayStats.roi.toFixed(1))"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- ROI Chart Modal -->
    <div x-show="showRoiModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      style="display: none;" @keydown.escape.window="closeRoiChart()">
      <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-4xl h-5/6 flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">–ì—Ä–∞—Ñ–∏–∫ ROI</h2>
          <button @click="closeRoiChart()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>

        <div class="flex space-x-4 mb-4 items-end">
          <div>
            <label class="block text-sm font-medium text-gray-700">üìÖ –ù–∞—á–∞–ª–æ</label>
            <input type="date" x-model="startDate" @change="updateChart()" class="border p-1 rounded">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">üìÖ –ö–æ–Ω–µ—Ü</label>
            <input type="date" x-model="endDate" @change="updateChart()" class="border p-1 rounded">
          </div>
        </div>

        <div class="flex-grow relative">
          <canvas id="roiChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/api.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/charts.js"></script>
  <script src="js/app.js"></script>
</body>

</html>