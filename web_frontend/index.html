<!doctype html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <title>Poker Stats</title>
  <script src="config.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs" defer></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body class="bg-gray-100 text-gray-900">
  <div class="max-w-6xl mx-auto p-4" x-data="userStatsTable()" x-init="init()">
    <h1 class="text-2xl font-bold mb-4">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–æ–≤</h1>

    <div class="flex flex-wrap gap-4 mb-4 items-end bg-white p-4 rounded shadow border border-gray-200">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">üìÖ –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞</label>
        <input type="date" x-model="tableStartDate" class="border p-2 rounded w-40">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">üìÖ –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞</label>
        <input type="date" x-model="tableEndDate" class="border p-2 rounded w-40">
      </div>
      <div class="flex-grow">
        <label class="block text-sm font-medium text-gray-700 mb-1">üîç –ü–æ–∏—Å–∫</label>
        <input type="text" x-model="search" placeholder="–ò–º—è –∏–ª–∏ ID" class="border p-2 rounded w-full" />
      </div>
    </div>

    <label class="flex items-center mb-4 space-x-2">
      <input type="checkbox" x-model="hideSmallSample" class="form-checkbox h-4 w-4 text-blue-600" />
      <span>–ù–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å, –µ—Å–ª–∏ –º–µ–Ω—å—à–µ —Ç—Ä—ë—Ö –∏–≥—Ä</span>
    </label>

    <div class="overflow-x-auto">
      <table class="min-w-full bg-white border border-gray-300 rounded shadow">
        <thead class="bg-gray-200">
          <tr>
            <template x-for="header in headers" :key="header.field">
              <th class="p-2 text-left cursor-pointer select-none" @click="setSort(header.field)"
                :title="header.tooltip">
                <span x-text="header.label"></span>
                <span x-show="sortField === header.field">
                  <span x-show="sortAsc">‚ñ≤</span>
                  <span x-show="!sortAsc">‚ñº</span>
                </span>
              </th>
            </template>
          </tr>
        </thead>
        <tbody>
          <template x-for="user in filteredAndSorted" :key="user.user_id">
            <tr class="border-t hover:bg-gray-50">
              <td class="p-2">
                <template x-if="user.displayStats.games_played >= 3">
                  <a href="#" @click.prevent="openRoiChart(user)" class="text-blue-600 hover:underline"
                    x-text="user.username ?? user.user_id"></a>
                </template>
                <template x-if="user.displayStats.games_played < 3">
                  <span x-text="user.username ?? user.user_id"></span>
                </template>
              </td>
              <td class="p-2" x-text="user.displayStats.games_played"></td>
              <td class="p-2" x-text="user.displayStats.total_buyin.toFixed(2)"></td>
              <td class="p-2" x-text="user.displayStats.avg_buyins_per_game.toFixed(2)"></td>
              <td class="p-2" x-text="user.displayStats.profit.toFixed(2)"></td>
              <td class="p-2" x-text="user.displayStats.roi.toFixed(1)"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- ROI Chart Modal -->
    <div x-show="showRoiModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      style="display: none;" @keydown.escape.window="closeRoiChart()">
      <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-4xl h-5/6 flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">–ì—Ä–∞—Ñ–∏–∫ ROI</h2>
          <button @click="closeRoiChart()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>

        <div class="flex space-x-4 mb-4 items-end">
          <div>
            <label class="block text-sm font-medium text-gray-700">üìÖ –ù–∞—á–∞–ª–æ</label>
            <input type="date" x-model="startDate" @change="updateChart()" class="border p-1 rounded">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">üìÖ –ö–æ–Ω–µ—Ü</label>
            <input type="date" x-model="endDate" @change="updateChart()" class="border p-1 rounded">
          </div>
        </div>

        <div class="flex-grow relative">
          <canvas id="roiChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const API_URL = CONFIG.API_URL;

    function userStatsTable() {
      return {
        users: [],
        search: "",
        sortField: "roi",
        sortAsc: false,
        hideSmallSample: true,

        // Main table date filter
        tableStartDate: '',
        tableEndDate: '',

        // Chart state
        showRoiModal: false,
        chartInstance: null,
        chartUser: null,
        roiData: [],
        startDate: '',
        endDate: '',

        headers: [
          { field: "username", label: "üë§ –ò–º—è / ID", tooltip: "" },
          { field: "games_played", label: "üé≤ –ò–≥—Ä—ã (—à—Ç)", tooltip: "" },
          { field: "total_buyin", label: "üí∞ –û–±—ä—ë–º –∑–∞–∫—É–ø–æ–≤ (EUR)", tooltip: "–û–±—â–∏–π –æ–±—ä—ë–º –∑–∞–∫—É–ø–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥" },
          { field: "avg_buyins_per_game", label: "üìä –°—Ä. –∫–æ–ª-–≤–æ –∑–∞–∫—É–ø–æ–≤ (—à—Ç)", tooltip: "–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫—É–ø–æ–≤ –∑–∞ –æ–¥–Ω—É –∏–≥—Ä—É –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥" },
          { field: "profit", label: "üìà –ü—Ä–∏–±—ã–ª—å (EUR)", tooltip: "" },
          { field: "roi", label: "üìâ ROI (%)", tooltip: "Return on Investment (ROI) ‚Äî –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å –≤–ª–æ–∂–µ–Ω–∏–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏ (–≤—ã–∏–≥—Ä—ã—à –º–∏–Ω—É—Å –∑–∞–∫—É–ø) –∫ –æ–±—â–µ–π —Å—É–º–º–µ –∑–∞–∫—É–ø–æ–≤. –§–æ—Ä–º—É–ª–∞: ((Profit / Total Buyin) * 100%)." },
        ],

        async init() {
          // Set default dates for main table: current year
          const now = new Date();
          const startOfYear = new Date(now.getFullYear(), 0, 1);

          const formatDate = (d) => {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
          };

          this.tableStartDate = formatDate(startOfYear);
          this.tableEndDate = formatDate(now);

          // Fetch users
          const res = await fetch(`${API_URL}/api/users`);
          const userList = await res.json();

          // Fetch full actions history for each user
          const enriched = await Promise.all(
            userList.users.map(async (user) => {
              try {
                const actionsRes = await fetch(`${API_URL}/api/stats/${user.user_id}/actions`);
                const data = await actionsRes.json();
                return { ...user, actions: data.actions };
              } catch (e) {
                console.error("Error fetching actions for user:", user.user_id, e);
                return { ...user, actions: [] };
              }
            })
          );

          this.users = enriched;
        },

        calculateStats(actions, startStr, endStr) {
          const start = new Date(startStr + 'T00:00:00').getTime();
          const end = new Date(endStr + 'T23:59:59').getTime();

          const filtered = actions.filter(a => {
            const t = new Date(a.timestamp).getTime();
            return t >= start && t <= end;
          });

          const games = new Set();
          let totalBuyin = 0;
          let totalQuit = 0;
          let buyinCount = 0;

          filtered.forEach(a => {
            games.add(a.game_id);
            if (a.action === 'buyin') {
              totalBuyin += a.amount || 0;
              buyinCount++;
            } else if (a.action === 'quit') {
              totalQuit += a.amount || 0;
            }
          });

          const gamesPlayed = games.size;
          const profit = totalQuit - totalBuyin;
          const roi = totalBuyin > 0 ? (profit / totalBuyin * 100) : 0;
          const avgBuyins = gamesPlayed > 0 ? (buyinCount / gamesPlayed) : 0;

          return {
            games_played: gamesPlayed,
            total_buyin: totalBuyin,
            avg_buyins_per_game: avgBuyins,
            profit: profit,
            roi: roi
          };
        },

        setSort(field) {
          if (this.sortField === field) {
            this.sortAsc = !this.sortAsc;
          } else {
            this.sortField = field;
            this.sortAsc = false;
          }
        },

        get filteredAndSorted() {
          // Add displayStats to each user based on current table date range
          const withStats = this.users.map(u => ({
            ...u,
            displayStats: this.calculateStats(u.actions, this.tableStartDate, this.tableEndDate)
          }));

          const filtered = withStats.filter((u) => {
            const name = u.username?.toLowerCase() ?? "";
            const id = u.user_id.toString();
            const nameMatches =
              name.includes(this.search.toLowerCase()) || id.includes(this.search);
            const sampleOk = !this.hideSmallSample || u.displayStats.games_played >= 3;
            return nameMatches && sampleOk;
          });

          return filtered.sort((a, b) => {
            let valA, valB;
            if (this.sortField === 'username') {
              valA = a.username || a.user_id.toString();
              valB = b.username || b.user_id.toString();
              if (valA === valB) return 0;
              return this.sortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
            } else {
              valA = a.displayStats[this.sortField];
              valB = b.displayStats[this.sortField];
              if (valA === valB) return 0;
              return this.sortAsc ? valA - valB : valB - valA;
            }
          });
        },

        async openRoiChart(user) {
          this.chartUser = user;
          this.showRoiModal = true;

          try {
            const res = await fetch(`${API_URL}/api/stats/${user.user_id}/roi`);
            if (!res.ok) throw new Error('Failed to fetch ROI history');
            this.roiData = await res.json();

            // Set dates based on data
            if (this.roiData.length > 0) {
              // Sort by date just in case
              const sortedData = [...this.roiData].sort((a, b) => new Date(a.date) - new Date(b.date));
              this.startDate = sortedData[0].date;
              this.endDate = sortedData[sortedData.length - 1].date;
            } else {
              // Fallback to today if no data (though button shouldn't be visible)
              const today = new Date().toISOString().split('T')[0];
              this.startDate = today;
              this.endDate = today;
            }

            // Wait for modal to render canvas
            this.$nextTick(() => {
              this.renderChart();
            });
          } catch (e) {
            console.error(e);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é ROI");
            this.showRoiModal = false;
          }
        },

        closeRoiChart() {
          this.showRoiModal = false;
          if (this.chartInstance) {
            this.chartInstance.destroy();
            this.chartInstance = null;
          }
        },

        get filteredRoiData() {
          if (!this.roiData) return [];
          const start = new Date(this.startDate).getTime();
          const end = new Date(this.endDate).getTime();

          return this.roiData.filter(item => {
            const itemDate = new Date(item.date).getTime();
            return itemDate >= start && itemDate <= end;
          });
        },

        renderChart() {
          const ctx = document.getElementById('roiChart').getContext('2d');

          if (this.chartInstance) {
            this.chartInstance.destroy();
          }

          const data = this.filteredRoiData;

          this.chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.map(d => d.date),
              datasets: [{
                label: 'ROI (%)',
                data: data.map(d => d.roi),
                borderColor: 'rgb(59, 130, 246)', // blue-500
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.1,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: false,
                  title: {
                    display: true,
                    text: 'ROI %'
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: '–î–∞—Ç–∞'
                  }
                }
              },
              plugins: {
                title: {
                  display: true,
                  text: `ROI History: ${this.chartUser.username ?? this.chartUser.user_id}`
                }
              }
            }
          });
        },

        updateChart() {
          if (this.chartInstance) {
            this.renderChart();
          }
        }
      };
    }
  </script>
</body>

</html>